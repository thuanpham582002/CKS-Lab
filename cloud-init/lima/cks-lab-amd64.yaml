# Lima template for CKS Lab - AMD64
# Converted from cloud-init/orbstack/amd64.yaml
# Date: 260101
# Description: Security-hardened Kubernetes 1.34.1 cluster for CKS exam preparation

vmType: vz
arch: x86_64
os: Linux
osVersion: ubuntu_22.04

# Resource configuration
cpus: 4
memory: 8GiB
disk: 100GiB

# Ubuntu 22.04 cloud image for AMD64
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img"
    arch: x86_64

# Mount home directory read-only
mounts:
  - location: "~"
    writable: false

# SSH configuration
ssh:
  loadDotSSHPubKeys: true
  localPort: 0

# Host resolver for DNS
hostResolver:
  enabled: true

# Port forwarding for Kubernetes
portForwards:
  - guestPort: 6443
    hostPort: 6443
    proto: tcp
    description: "Kubernetes API Server"
  - guestPortRange:
      min: 30000
      max: 32767
    hostPortRange:
      min: 30000
      max: 32767
    proto: tcp
    description: "Kubernetes NodePort range"

# Provisioning scripts
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      echo "=== Starting CKS Lab Provisioning ==="
      echo "Date: $(date)"
      echo "Architecture: $(uname -m)"

      # System configuration
      echo "=== Configuring hostname ==="
      hostnamectl set-hostname cks-lab-node

      # Configure timezone
      timedatectl set-timezone UTC

      # Update and upgrade packages
      echo "=== Updating system packages ==="
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get upgrade -y

      # Install required packages
      echo "=== Installing base packages ==="
      apt-get install -y \
        apt-transport-https \
        ca-certificates \
        curl \
        gnupg \
        lsb-release \
        software-properties-common \
        ufw \
        apparmor \
        apparmor-utils \
        auditd \
        unzip \
        wget \
        dnsutils \
        net-tools \
        iproute2 \
        iputils-ping \
        telnet \
        nmap \
        tcpdump \
        traceroute \
        mtr \
        lsof \
        strace \
        jq \
        yq \
        tracee

      # Kernel security parameters
      echo "=== Configuring kernel security parameters ==="
      cat > /etc/sysctl.d/99-cks-security.conf <<'EOF'
      # Network Security
      net.ipv4.ip_forward = 1
      net.ipv4.conf.all.send_redirects = 0
      net.ipv4.conf.default.send_redirects = 0
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv4.conf.default.accept_redirects = 0
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1

      # Memory protection
      vm.swappiness = 10
      kernel.kptr_restrict = 2
      kernel.dmesg_restrict = 1
      kernel.kexec_load_disabled = 1

      # File system
      fs.protected_regular = 1
      fs.protected_fifos = 1
      fs.suid_dumpable = 0
      EOF

      # Apply sysctl parameters
      sysctl --system

      # Enable and configure firewall
      echo "=== Configuring UFW firewall ==="
      ufw --force enable
      ufw default deny incoming
      ufw default allow outgoing
      ufw allow ssh
      ufw allow 6443/tcp
      ufw allow 10250/tcp
      ufw reload

      # Enable AppArmor
      echo "=== Enabling AppArmor ==="
      systemctl enable apparmor
      systemctl start apparmor
      aa-enforce /etc/apparmor.d/*

      # Enable auditd
      echo "=== Enabling auditd ==="
      systemctl enable auditd
      systemctl start auditd

      # Add Kubernetes repository (v1.34)
      echo "=== Adding Kubernetes repository ==="
      curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | \
        gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
        https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /' | \
        tee /etc/apt/sources.list.d/kubernetes.list

      # Add Docker repository for containerd
      echo "=== Adding Docker repository ==="
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
        gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg
      echo "deb [arch=$(dpkg --print-architecture) \
        signed-by=/etc/apt/keyrings/docker.gpg] \
        https://download.docker.com/linux/ubuntu jammy stable" | \
        tee /etc/apt/sources.list.d/docker.list > /dev/null

      # Add cri-dockerd repository
      echo "=== Adding cri-dockerd repository ==="
      curl -fsSL https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable/xUbuntu_22.04/Release.key | \
        gpg --dearmor | sudo tee /etc/apt/keyrings/cri-dockerd.gpg > /dev/null
      echo "deb [signed-by=/etc/apt/keyrings/cri-dockerd.gpg] \
        https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable/xUbuntu_22.04/ /" | \
        sudo tee /etc/apt/sources.list.d/cri-dockerd.list > /dev/null

      # Update package lists
      apt-get update

      # Install Docker as container runtime
      echo "=== Installing Docker ==="
      apt-get install -y docker.io
      systemctl enable docker
      systemctl start docker

      # Install cri-dockerd manually (v0.3.21 AMD64)
      echo "=== Installing cri-dockerd ==="
      curl -L https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.21/cri-dockerd-0.3.21.amd64.tgz \
        -o cri-dockerd.tgz
      tar -xzf cri-dockerd.tgz
      sudo cp cri-dockerd/cri-dockerd /usr/local/bin/
      sudo chmod +x /usr/local/bin/cri-dockerd

      # Download cri-dockerd systemd service files
      curl -L https://raw.githubusercontent.com/Mirantis/cri-dockerd/v0.3.21/packaging/systemd/cri-docker.service \
        -o cri-docker.service
      curl -L https://raw.githubusercontent.com/Mirantis/cri-dockerd/v0.3.21/packaging/systemd/cri-docker.socket \
        -o cri-docker.socket
      sudo mv cri-docker.service cri-docker.socket /etc/systemd/system/

      # Fix cri-dockerd path in service file
      sudo sed -i 's|/usr/bin/cri-dockerd|/usr/local/bin/cri-dockerd|g' \
        /etc/systemd/system/cri-docker.service

      # Enable and start cri-dockerd service
      sudo systemctl daemon-reload
      sudo systemctl enable --now cri-docker.socket
      sudo systemctl enable --now cri-docker.service

      # Configure Docker daemon for Kubernetes
      echo "=== Configuring Docker daemon ==="
      cat <<EOF | sudo tee /etc/docker/daemon.json
      {
        "exec-opts": ["native.cgroupdriver=systemd"],
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "100m"
        },
        "storage-driver": "overlay2",
        "live-restore": true,
        "userland-proxy": false,
        "experimental": true,
        "metrics-addr": "127.0.0.1:9323"
      }
      EOF

      # Create Docker service override
      mkdir -p /etc/systemd/system/docker.service.d
      cat <<EOF | sudo tee /etc/systemd/system/docker.service.d/cri.conf
      [Service]
      ExecStart=
      ExecStart=/usr/bin/dockerd
      Environment="DOCKERD_OPTS=--containerd=/run/containerd/containerd.sock"
      EOF

      systemctl daemon-reload
      systemctl restart docker

      # Verify Docker and cri-dockerd
      echo "=== Verifying Docker and cri-dockerd ==="
      sleep 10
      docker info
      ls -la /var/run/docker.sock
      ls -la /var/run/cri-dockerd.sock
      cri-dockerd --version

      # Install Kubernetes components (v1.34.1)
      echo "=== Installing Kubernetes components ==="
      apt-get install -y kubelet=1.34.1-1.1 kubeadm=1.34.1-1.1 kubectl=1.34.1-1.1
      apt-mark hold kubelet kubeadm kubectl
      systemctl enable kubelet

      # Disable swap for Kubernetes
      echo "=== Disabling swap ==="
      swapoff -a
      sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

      # Create swap disable service
      cat <<'EOF' > /usr/local/bin/disable-swap.sh
      #!/bin/bash
      logger "Disabling swap for Kubernetes..."
      swapoff -a
      if [ $? -eq 0 ]; then
        logger "Swap disabled successfully"
      else
        logger "Failed to disable swap"
        exit 1
      fi
      EOF
      chmod +x /usr/local/bin/disable-swap.sh

      cat <<'EOF' > /etc/systemd/system/disable-swap.service
      [Unit]
      Description=Disable swap for Kubernetes
      After=multi-user.target
      Before=kubelet.service

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/disable-swap.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
      EOF

      systemctl daemon-reload
      systemctl enable disable-swap.service

      # Enable kernel modules
      echo "=== Enabling kernel modules ==="
      cat <<EOF | tee /etc/modules-load.d/k8s.conf
      overlay
      br_netfilter
      EOF
      modprobe overlay
      modprobe br_netfilter

      # Apply sysctl params
      sysctl --system

      # Create Kubernetes directories
      mkdir -p /etc/kubernetes/pki
      mkdir -p /var/lib/kubernetes
      mkdir -p /var/log/kubernetes

      # Initialize Kubernetes cluster
      echo "=== Initializing Kubernetes cluster ==="
      kubeadm init \
        --kubernetes-version=v1.34.1 \
        --pod-network-cidr=10.244.0.0/16 \
        --cri-socket=unix:///var/run/cri-dockerd.sock \
        --ignore-preflight-errors=NumCPU

      echo "=== Configuring kubectl ==="
      mkdir -p /root/.kube
      cp -i /etc/kubernetes/admin.conf /root/.kube/config
      export KUBECONFIG=/etc/kubernetes/admin.conf

      # Wait for API server
      echo "=== Waiting for API server ==="
      kubectl wait --for=condition=ready pods -n kube-system \
        -l component=kube-apiserver --timeout=300s

      # Remove taint from control plane
      kubectl taint nodes --all node-role.kubernetes.io/control-plane-

      # Install Cilium CLI
      echo "=== Installing Cilium CLI ==="
      CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
      CLI_ARCH=amd64
      curl -L --fail --remote-name-all \
        https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
      sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
      sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin/
      rm -f cilium-linux-${CLI_ARCH}.tar.gz cilium-linux-${CLI_ARCH}.tar.gz.sha256sum

      # Install Cilium CNI
      echo "=== Installing Cilium CNI ==="
      export KUBECONFIG=/etc/kubernetes/admin.conf
      cilium install --version 1.18.4

      # Wait for Cilium pods
      kubectl wait --for=condition=ready pods -n kube-system \
        -l app.kubernetes.io/part-of=cilium --timeout=300s

      # Configure kube-proxy with custom conntrack settings
      echo "=== Configuring kube-proxy ==="
      cat <<'EOF' > /tmp/kube-proxy-config.yaml
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: kube-proxy
        namespace: kube-system
      data:
        config.conf: |-
          apiVersion: kubeproxy.config.k8s.io/v1alpha1
          bindAddress: 0.0.0.0
          bindAddressHardFail: false
          clientConnection:
            acceptContentTypes: ""
            burst: 10
            contentType: ""
            kubeconfig: /var/lib/kube-proxy/kubeconfig.conf
            qps: 5
          clusterCIDR: 10.244.0.0/16
          configSyncPeriod: 0s
          conntrack:
            maxPerCore: 0
            min: 0
            tcpBeLiberal: false
            tcpCloseWaitTimeout: 0s
            tcpEstablishedTimeout: 0s
            udpStreamTimeout: 0s
            udpTimeout: 0s
          detectLocal:
            bridgeInterface: ""
            interfaceNamePrefix: ""
            detectLocalMode: ""
          enableProfiling: false
          healthzBindAddress: ""
          hostnameOverride: ""
          iptables:
            localhostNodePorts: null
            masqueradeAll: false
            masqueradeBit: null
            minSyncPeriod: 0s
            syncPeriod: 30s
          ipvs:
            excludeCIDRs: null
            minSyncPeriod: 0s
            scheduler: ""
            strictARP: false
            syncPeriod: 0s
            tcpFinTimeout: 0s
            tcpTimeout: 0s
            udpTimeout: 0s
          kind: KubeProxyConfiguration
          logging:
            flushFrequency: 0
            options:
              json:
                infoBufferSize: "0"
              text:
                infoBufferSize: "0"
            verbosity: 0
          metricsBindAddress: ""
          mode: "iptables"
          nftables:
            masqueradeAll: false
            masqueradeBit: null
            minSyncPeriod: 0s
            syncPeriod: 0s
          nodePortAddresses: null
          oomScoreAdj: null
          portRange: ""
          showHiddenMetricsForVersion: ""
          winkernel:
            enableDSR: false
            forwardHealthCheckVip: false
            networkName: ""
            rootHnsEndpointName: ""
            sourceVip: ""
      EOF

      kubectl apply -f /tmp/kube-proxy-config.yaml
      kubectl delete pods -n kube-system -l k8s-app=kube-proxy
      kubectl wait --for=condition=ready pods -n kube-system \
        -l k8s-app=kube-proxy --timeout=300s

      # Display cluster status
      echo "=== Cluster Status ==="
      kubectl get nodes -o wide
      kubectl get pods -n kube-system

      # Install security tools
      echo "=== Installing security tools ==="

      # Install kube-bench (v0.8.0 AMD64)
      curl -L https://github.com/aquasecurity/kube-bench/releases/download/v0.8.0/kube-bench_0.8.0_linux_amd64.deb \
        -o /tmp/kube-bench.deb
      sudo dpkg -i /tmp/kube-bench.deb || sudo apt-get install -f -y

      # Install Trivy (v0.55.0 AMD64)
      wget https://github.com/aquasecurity/trivy/releases/download/v0.55.0/trivy_0.55.0_Linux-64bit.tar.gz \
        -O /tmp/trivy.tar.gz
      tar -xzf /tmp/trivy.tar.gz -C /tmp
      sudo mv /tmp/trivy /usr/local/bin/
      sudo chmod +x /usr/local/bin/trivy

      # Install Helm (v3.17.0 AMD64)
      curl https://get.helm.sh/helm-v3.17.0-linux-amd64.tar.gz -o /tmp/helm.tar.gz
      tar -zxvf /tmp/helm.tar.gz -C /tmp
      sudo mv /tmp/linux-amd64/helm /usr/local/bin/
      sudo chmod +x /usr/local/bin/helm

      # Final system hardening
      chmod 600 /etc/kubernetes/pki/* || true

      echo "=== CKS Lab Provisioning Complete ==="
      echo "Kubernetes cluster is ready!"
      echo "Access with: kubectl get nodes"

# Probe to check if VM is ready
provisionAfter:
  - shell: |
      set -eux
      until kubectl get nodes &>/dev/null; do
        echo "Waiting for Kubernetes to be ready..."
        sleep 5
      done
      echo "Kubernetes is ready!"

# Firmware configuration for macOS Virtualization framework
firmware:
  legacyBIOS: false
