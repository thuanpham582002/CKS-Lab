---
apiVersion: v1
kind: Namespace
metadata:
  name: security-tools
  labels:
    name: security-tools
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-rules
  namespace: security-tools
  labels:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: rules
data:
  # Include the custom CKS rules from configs/falco-rules.yaml
  cks_rules.yaml: |
    # Paste your custom rules here or mount the file directly
    - list: memoryfile
      items: [/dev/mem, /dev/kmem, /dev/port]
    - rule: Detect Memory Access
      desc: Detect attempts to access memory devices
      condition: >
        fd.name in (memoryfile)
      output: >
        Memory device access detected (user=%user.name command=%proc.cmdline container=%container.name fd=%fd.name)
      priority: HIGH
      tags: [security, memory, cks]
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falco
  namespace: security-tools
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: falco
rules:
- apiGroups:
  - ""
  resources:
  - nodes
  - pods
  - services
  - namespaces
  - endpoints
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - extensions
  resources:
  - replicasets
  - daemonsets
  - deployments
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apps
  resources:
  - replicasets
  - daemonsets
  - deployments
  - statefulsets
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - nodes/metrics
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - batch
  resources:
  - jobs
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - clusterroles
  - clusterrolebindings
  - roles
  - rolebindings
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: falco
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: falco
subjects:
- kind: ServiceAccount
  name: falco
  namespace: security-tools
---
apiVersion: v1
kind: Secret
metadata:
  name: falco-config
  namespace: security-tools
stringData:
  falco.yaml: |
    # Falco configuration for CKS lab
    base_ruleset:
      - /etc/falco/rules.d
    watch_config_files: true
    log_level: info
    log_format: json
    priority: warning
    outputs:
      - program:
          enabled: true
          keep_alive: false
      - syslog:
          enabled: false
      - file:
          enabled: true
          keep_alive: false
          filename: /var/log/falco_events.log
      - stdout:
          enabled: true
      - http:
          enabled: true
          url: http://falco-event-gateway.security-tools.svc.cluster.local:2801
      - loki:
          enabled: false
          url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
          labels:
            job: falco
            source: kubernetes
    json_output: true
    json_include_output_property: true
    buffer_outputs: true
    buffered_outputs: file
    syslog_output:
      enabled: false
    program_output:
      enabled: true
      keep_alive: false
      program: jq '{message: .output}' >> /var/log/falco_events.log
    file_output:
      enabled: true
      keep_alive: false
      filename: /var/log/falco_events.log
    stdout_output:
      enabled: true
      keep_alive: false
    http_output:
      enabled: true
      url: http://falco-event-gateway.security-tools.svc.cluster.local:2801
      user_agent: falco
    grpc_output:
      enabled: false
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
  namespace: security-tools
  labels:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: daemon
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: falco
      app.kubernetes.io/component: daemon
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: falco
        app.kubernetes.io/component: daemon
      annotations:
        checksum/config: d4e7f8a9b2c3e5d6
    spec:
      serviceAccountName: falco
      priorityClassName: system-node-critical
      hostNetwork: true
      hostPID: true
      hostIPC: true
      dnsPolicy: ClusterFirstWithHostNet
      tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      containers:
      - name: falco
        image: falcosecurity/falco:0.42.0
        imagePullPolicy: IfNotPresent
        args:
        - /usr/bin/falco
        - --cri=/run/containerd/containerd.sock
        - -K
        - /var/run/secrets/kubernetes.io/serviceaccount/token
        - -k
        - https://kubernetes.default.svc:443
        - -pk
        - -tp
        - -v
        - /etc/falco/falco_rules.yaml
        - --pidfile=/var/run/falco.pid
        resources:
          limits:
            cpu: 1000m
            memory: 512Mi
          requests:
            cpu: 200m
            memory: 128Mi
        env:
        - name: HOST_ROOT
          value: /host
        - name: FALCO_BPF_PROBE
          value: ""
        - name: SYSDIG_HOST_ROOT
          value: /host
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        securityContext:
          privileged: true
          runAsUser: 0
        volumeMounts:
        - name: root-fs
          readOnly: true
          mountPath: /host
        - name: dev-fs
          readOnly: true
          mountPath: /host/dev
        - name: proc-fs
          readOnly: true
          mountPath: /host/proc
        - name: boot-fs
          readOnly: true
          mountPath: /host/boot
        - name: lib-modules
          readOnly: true
          mountPath: /host/lib/modules
        - name: usr-libs
          readOnly: true
          mountPath: /host/usr/lib
        - name: etc-passwd
          readOnly: true
          mountPath: /host/etc/passwd
        - name: etc-group
          readOnly: true
          mountPath: /host/etc/group
        - name: etc-os-release
          readOnly: true
          mountPath: /host/etc/os-release
        - name: etc-machine-id
          readOnly: true
          mountPath: /host/etc/machine-id
        - name: etc-falco
          readOnly: true
          mountPath: /etc/falco
        - name: var-lib-falco
          mountPath: /var/lib/falco
        - name: var-run-falco
          mountPath: /var/run/falco
        - name: var-log
          mountPath: /var/log
        - name: falco-config
          mountPath: /etc/falco/falco.yaml
          subPath: falco.yaml
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - 'if [ -e /var/run/falco.pid ]; then kill -0 $(cat /var/run/falco.pid); else echo "PID file not found"; exit 1; fi'
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
      terminationGracePeriodSeconds: 30
      volumes:
      - name: root-fs
        hostPath:
          path: /
      - name: dev-fs
        hostPath:
          path: /dev
      - name: proc-fs
        hostPath:
          path: /proc
      - name: boot-fs
        hostPath:
          path: /boot
      - name: lib-modules
        hostPath:
          path: /lib/modules
      - name: usr-libs
        hostPath:
          path: /usr/lib
      - name: etc-passwd
        hostPath:
          path: /etc/passwd
      - name: etc-group
        hostPath:
          path: /etc/group
      - name: etc-os-release
        hostPath:
          path: /etc/os-release
      - name: etc-machine-id
        hostPath:
          path: /etc/machine-id
      - name: etc-falco
        configMap:
          name: falco-rules
      - name: var-lib-falco
        emptyDir: {}
      - name: var-run-falco
        emptyDir: {}
      - name: var-log
        hostPath:
          path: /var/log
      - name: falco-config
        secret:
          secretName: falco-config
---
# Falco event gateway for processing alerts
apiVersion: v1
kind: Service
metadata:
  name: falco-event-gateway
  namespace: security-tools
  labels:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: event-gateway
spec:
  ports:
  - name: http
    port: 2801
    protocol: TCP
    targetPort: 2801
  selector:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: event-gateway
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: falco-event-gateway
  namespace: security-tools
  labels:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: event-gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: falco
      app.kubernetes.io/component: event-gateway
  template:
    metadata:
      labels:
        app.kubernetes.io/name: falco
        app.kubernetes.io/component: event-gateway
    spec:
      containers:
      - name: event-gateway
        image: falcosecurity/event-gateway:0.3.2
        ports:
        - containerPort: 2801
          name: http
          protocol: TCP
        env:
        - name: GATEWAY_OUTPUT_FORMAT
          value: "json"
        - name: GATEWAY_FORWARDER_TYPE
          value: "webhook"
        resources:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 64Mi
---
# Falco service for accessing metrics (optional)
apiVersion: v1
kind: Service
metadata:
  name: falco-metrics
  namespace: security-tools
  labels:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: metrics
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8765"
    prometheus.io/path: "/metrics"
spec:
  ports:
  - name: metrics
    port: 8765
    protocol: TCP
    targetPort: 8765
  selector:
    app.kubernetes.io/name: falco
    app.kubernetes.io/component: daemon