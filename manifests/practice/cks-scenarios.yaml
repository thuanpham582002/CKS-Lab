---
# CKS Practice Scenarios
# These manifests create vulnerable workloads for security remediation practice

# Namespace for CKS practice scenarios
apiVersion: v1
kind: Namespace
metadata:
  name: cks-practice
  labels:
    name: cks-practice
    pod-security.kubernetes.io/enforce: baseline
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted

---
# Scenario 1: Privileged container (should be fixed)
apiVersion: v1
kind: Pod
metadata:
  name: privileged-pod-vulnerable
  namespace: cks-practice
  labels:
    scenario: "1"
    security-issue: "privileged"
spec:
  containers:
  - name: ubuntu
    image: ubuntu:22.04
    command: ["sleep", "3600"]
    securityContext:
      privileged: true  # VULNERABILITY: Privileged container
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# Scenario 2: Pod running as root (should be fixed)
apiVersion: v1
kind: Pod
metadata:
  name: root-pod-vulnerable
  namespace: cks-practice
  labels:
    scenario: "2"
    security-issue: "run-as-root"
spec:
  containers:
  - name: nginx
    image: nginx:1.25-alpine
    securityContext:
      runAsUser: 0  # VULNERABILITY: Running as root
      allowPrivilegeEscalation: true  # VULNERABILITY: Privilege escalation allowed
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# Scenario 3: Pod with access to host filesystem (should be fixed)
apiVersion: v1
kind: Pod
metadata:
  name: host-fs-pod-vulnerable
  namespace: cks-practice
  labels:
    scenario: "3"
    security-issue: "host-filesystem"
spec:
  containers:
  - name: debug
    image: busybox:1.36
    command: ["sleep", "3600"]
    volumeMounts:
    - name: host-root
      mountPath: /host  # VULNERABILITY: Host filesystem mounted
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
  volumes:
  - name: host-root
    hostPath:
      path: /  # VULNERABILITY: Mounting host root filesystem

---
# Scenario 4: Pod with ALL capabilities (should be fixed)
apiVersion: v1
kind: Pod
metadata:
  name: all-caps-pod-vulnerable
  namespace: cks-practice
  labels:
    scenario: "4"
    security-issue: "all-capabilities"
spec:
  containers:
  - name: container
    image: alpine:3.19
    command: ["sleep", "3600"]
    securityContext:
      capabilities:
        add: ["ALL"]  # VULNERABILITY: All capabilities added
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# Scenario 5: Pod with Docker socket mounted (should be fixed)
apiVersion: v1
kind: Pod
metadata:
  name: docker-socket-pod-vulnerable
  namespace: cks-practice
  labels:
    scenario: "5"
    security-issue: "docker-socket"
spec:
  containers:
  - name: docker
    image: docker:24.0-cli
    command: ["sleep", "3600"]
    volumeMounts:
    - name: docker-socket
      mountPath: /var/run/docker.sock  # VULNERABILITY: Docker socket mounted
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
  volumes:
  - name: docker-socket
    hostPath:
      path: /var/run/docker.sock  # VULNERABILITY: Docker socket from host

---
# Scenario 6: Pod with sensitive host paths mounted
apiVersion: v1
kind: Pod
metadata:
  name: sensitive-host-paths-vulnerable
  namespace: cks-practice
  labels:
    scenario: "6"
    security-issue: "sensitive-host-paths"
spec:
  containers:
  - name: debug
    image: busybox:1.36
    command: ["sleep", "3600"]
    volumeMounts:
    - name: etc
      mountPath: /host-etc  # VULNERABILITY: Sensitive host paths mounted
    - name: var-log
      mountPath: /host-log  # VULNERABILITY: Logs accessible
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
  volumes:
  - name: etc
    hostPath:
      path: /etc
  - name: var-log
    hostPath:
      path: /var/log

---
# Scenario 7: ServiceAccount with excessive permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: privileged-sa
  namespace: cks-practice

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: privileged-sa-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin  # VULNERABILITY: Cluster admin permissions
subjects:
- kind: ServiceAccount
  name: privileged-sa
  namespace: cks-practice

---
apiVersion: v1
kind: Pod
metadata:
  name: service-account-vulnerable
  namespace: cks-practice
  labels:
    scenario: "7"
    security-issue: "service-account"
spec:
  serviceAccountName: privileged-sa  # VULNERABILITY: Using privileged service account
  containers:
  - name: container
    image: nginx:1.25-alpine
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# Scenario 8: Image from untrusted registry
apiVersion: v1
kind: Pod
metadata:
  name: untrusted-image-vulnerable
  namespace: cks-practice
  labels:
    scenario: "8"
    security-issue: "untrusted-image"
spec:
  containers:
  - name: container
    image: unknown-registry.com/suspicious/image:latest  # VULNERABILITY: Untrusted image
    command: ["sleep", "3600"]
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# Scenario 9: Pod with hostNetwork access
apiVersion: v1
kind: Pod
metadata:
  name: host-network-vulnerable
  namespace: cks-practice
  labels:
    scenario: "9"
    security-issue: "host-network"
spec:
  hostNetwork: true  # VULNERABILITY: Host network access
  hostPID: true  # VULNERABILITY: Host PID access
  hostIPC: true  # VULNERABILITY: Host IPC access
  containers:
  - name: container
    image: nginx:1.25-alpine
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# Scenario 10: Pod with writeable root filesystem and no security context
apiVersion: v1
kind: Pod
metadata:
  name: insecure-context-vulnerable
  namespace: cks-practice
  labels:
    scenario: "10"
    security-issue: "no-security-context"
spec:
  # No securityContext defined - VULNERABILITY: Uses default insecure settings
  containers:
  - name: container
    image: nginx:1.25-alpine
    # No securityContext for container - VULNERABILITY
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# Secure versions of the same pods for comparison

# Secure version 1: Non-privileged container
apiVersion: v1
kind: Pod
metadata:
  name: privileged-pod-secure
  namespace: cks-practice
  labels:
    scenario: "1"
    security-status: "secure"
spec:
  containers:
  - name: ubuntu
    image: ubuntu:22.04
    command: ["sleep", "3600"]
    securityContext:
      privileged: false  # FIXED: Not privileged
      runAsNonRoot: true  # FIXED: Run as non-root
      runAsUser: 101
      readOnlyRootFilesystem: true  # FIXED: Read-only filesystem
      allowPrivilegeEscalation: false  # FIXED: No privilege escalation
      capabilities:
        drop: ["ALL"]  # FIXED: Drop all capabilities
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# Secure version 2: Container with limited capabilities
apiVersion: v1
kind: Pod
metadata:
  name: capabilities-pod-secure
  namespace: cks-practice
  labels:
    scenario: "4"
    security-status: "secure"
spec:
  containers:
  - name: container
    image: alpine:3.19
    command: ["sleep", "3600"]
    securityContext:
      runAsNonRoot: true
      runAsUser: 101
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]  # FIXED: Drop all capabilities
        add: ["NET_BIND_SERVICE"]  # FIXED: Add only needed capabilities
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

---
# NetworkPolicy for the cks-practice namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cks-practice-default-deny
  namespace: cks-practice
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# Allow DNS for cks-practice namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-cks-practice
  namespace: cks-practice
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# ConfigMap for practice instructions
apiVersion: v1
kind: ConfigMap
metadata:
  name: practice-instructions
  namespace: cks-practice
data:
  instructions.md: |
    # CKS Practice Scenarios Instructions

    This namespace contains vulnerable workloads that you need to secure. Each pod is labeled with a scenario number and the security issue it demonstrates.

    ## Scenarios:

    ### Scenario 1: Privileged Container (security-issue: privileged)
    - **Issue**: Pod running in privileged mode
    - **Fix**: Remove privileged mode and apply least privilege
    - **Command to find**: `kubectl get pod -l security-issue=privileged -n cks-practice`

    ### Scenario 2: Running as Root (security-issue: run-as-root)
    - **Issue**: Container running as root user
    - **Fix**: Run as non-root user with least privileges
    - **Command to find**: `kubectl get pod -l security-issue=run-as-root -n cks-practice`

    ### Scenario 3: Host Filesystem Access (security-issue: host-filesystem)
    - **Issue**: Pod has access to host filesystem
    - **Fix**: Remove host filesystem mounts
    - **Command to find**: `kubectl get pod -l security-issue=host-filesystem -n cks-practice`

    ### Scenario 4: All Capabilities (security-issue: all-capabilities)
    - **Issue**: Container has all Linux capabilities
    - **Fix**: Drop all capabilities and add only what's needed
    - **Command to find**: `kubectl get pod -l security-issue=all-capabilities -n cks-practice`

    ### Scenario 5: Docker Socket Mount (security-issue: docker-socket)
    - **Issue**: Pod has access to Docker socket
    - **Fix**: Remove Docker socket mount
    - **Command to find**: `kubectl get pod -l security-issue=docker-socket -n cks-practice`

    ### Scenario 6: Sensitive Host Paths (security-issue: sensitive-host-paths)
    - **Issue**: Pod mounts sensitive host paths
    - **Fix**: Remove sensitive host path mounts
    - **Command to find**: `kubectl get pod -l security-issue=sensitive-host-paths -n cks-practice`

    ### Scenario 7: Privileged ServiceAccount (security-issue: service-account)
    - **Issue**: Pod uses cluster-admin service account
    - **Fix**: Create appropriate RBAC with least privileges
    - **Command to find**: `kubectl get pod -l security-issue=service-account -n cks-practice`

    ### Scenario 8: Untrusted Image (security-issue: untrusted-image)
    - **Issue**: Image from untrusted registry
    - **Fix**: Use images from trusted registries only
    - **Command to find**: `kubectl get pod -l security-issue=untrusted-image -n cks-practice`

    ### Scenario 9: Host Namespace Access (security-issue: host-network)
    - **Issue**: Pod uses host network, PID, and IPC namespaces
    - **Fix**: Remove host namespace access
    - **Command to find**: `kubectl get pod -l security-issue=host-network -n cks-practice`

    ### Scenario 10: No Security Context (security-issue: no-security-context)
    - **Issue**: Pod lacks security context configuration
    - **Fix**: Apply appropriate security context
    - **Command to find**: `kubectl get pod -l security-issue=no-security-context -n cks-practice`

    ## Validation Commands:

    # Check for privileged pods:
    kubectl get pods -n cks-practice -o custom-columns=NAME:.metadata.name,PRIVILEGED:.spec.containers[0].securityContext.privileged

    # Check for pods running as root:
    kubectl get pods -n cks-practice -o custom-columns=NAME:.metadata.name,RUNASUSER:.spec.containers[0].securityContext.runAsUser

    # Check for host filesystem mounts:
    kubectl get pods -n cks-practice -o jsonpath='{.items[*].spec.volumes[?(@.hostPath)]}'

    # Check security context capabilities:
    kubectl get pods -n cks-practice -o jsonpath='{.items[*].spec.containers[0].securityContext.capabilities}'

    # Run kube-bench for validation:
    kube-bench run --target node

    # Run Falco to monitor activities:
    kubectl logs -n security-tools -l app.kubernetes.io/name=falco -f